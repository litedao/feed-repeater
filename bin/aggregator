#!/usr/bin/env node
var command = process.argv[2]
var args    = process.argv.slice(3)

var TIMEOUT = 1 * 60 * 1000

function fail(message) {
  console.error("aggregator: " + message)
  process.exit(1)
}

function dump(object) {
  console.log(JSON.stringify(object, null, 2))
}

if (command.replace(/^--/, "") == "version") {
  console.log(require("../package.json").version)
  process.exit(0)
}

var aggregator = (function() {
  try {
    return require("..")()
  } catch (error) {
    fail(error.message)
  }
})()

var method

if (command == "inspect") {
  dump(aggregator.inspect(args[0]))
} else if (command == "watch") {
  aggregator.filter({}, function(error, id) {
    if (error) {
      fail(error.message)
    } else {
      dump(aggregator.inspect(id))
    }
  })
} else if (method = aggregator[command.replace(/-/g, "_")]) {
  method.apply(aggregator, args)

  if (command == "claim") {
    setTimeout(function() {
      fail("error: timed out (unsynced blockchain?)")
    }, TIMEOUT)

    aggregator.filter({}, function(error, id) {
      if (error) {
        fail(error.message)
      } else if (aggregator.owner(id) == aggregator.account) {
        dump(aggregator.inspect(id));
        process.exit(0)
      } else {
        console.warn(JSON.stringify(
          aggregator.inspect(id), null, 2
        ).replace(/^/gm, "debug: "));
      }
    })
  }
} else {
  fail("error: unknown command: " + command)
}
